name: AuraCap Ingest Dispatch

on:
  repository_dispatch:
    types: [auracap_ingest]
  workflow_dispatch:
    inputs:
      media_type:
        description: screenshot or audio
        required: true
        default: screenshot
      mime_type:
        description: mime type
        required: true
        default: image/png
      asset_id:
        description: GitHub release asset id (preferred for GitHub-only)
        required: false
      payload_ref:
        description: temporary media URL (legacy fallback)
        required: false
      locale:
        description: output locale
        required: false
        default: zh-CN
      timezone:
        description: timezone
        required: false
        default: local

concurrency:
  group: auracap-ingest-${{ github.ref }}
  cancel-in-progress: false

jobs:
  process:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      APP_ENV: production

      OUTPUT_LOCALE: ${{ vars.OUTPUT_LOCALE || 'zh-CN' }}
      DEFAULT_TIMEZONE: ${{ vars.DEFAULT_TIMEZONE || 'local' }}
      TIMESTAMP_FORMAT: ${{ vars.TIMESTAMP_FORMAT || '%Y-%m-%d %H:%M:%S %Z' }}

      EXTRACT_ONLY: ${{ vars.EXTRACT_ONLY || 'false' }}
      ENABLE_INSIGHTS: ${{ vars.ENABLE_INSIGHTS || 'true' }}
      ENABLE_SUMMARY: ${{ vars.ENABLE_SUMMARY || 'true' }}
      ENABLE_CUSTOM_OPERATION: ${{ vars.ENABLE_CUSTOM_OPERATION || 'false' }}
      AUDIO_MODE: ${{ vars.AUDIO_MODE || 'TRANSCRIBE_THEN_ANALYZE' }}
      TIMELINE_LANG_MODE: ${{ vars.TIMELINE_LANG_MODE || 'request_locale' }}

      TEXT_PROVIDER: ${{ vars.TEXT_PROVIDER || 'mock' }}
      MM_PROVIDER: ${{ vars.MM_PROVIDER || 'mock' }}
      ASR_PROVIDER: ${{ vars.ASR_PROVIDER || 'mock' }}
      PROVIDER_TIMEOUT_SECONDS: ${{ vars.PROVIDER_TIMEOUT_SECONDS || '120' }}

      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENAI_BASE_URL: ${{ vars.OPENAI_BASE_URL || 'https://api.openai.com/v1' }}
      OPENAI_TEXT_MODEL: ${{ vars.OPENAI_TEXT_MODEL || 'gpt-4.1-mini' }}
      OPENAI_MM_MODEL: ${{ vars.OPENAI_MM_MODEL || 'gpt-4.1-mini' }}
      OPENAI_ASR_MODEL: ${{ vars.OPENAI_ASR_MODEL || 'gpt-4o-mini-transcribe' }}

      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      ANTHROPIC_BASE_URL: ${{ vars.ANTHROPIC_BASE_URL || 'https://api.anthropic.com' }}
      ANTHROPIC_TEXT_MODEL: ${{ vars.ANTHROPIC_TEXT_MODEL || 'claude-3-7-sonnet-latest' }}
      ANTHROPIC_MM_MODEL: ${{ vars.ANTHROPIC_MM_MODEL || 'claude-3-7-sonnet-latest' }}

      GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      GOOGLE_BASE_URL: ${{ vars.GOOGLE_BASE_URL || 'https://generativelanguage.googleapis.com' }}
      GOOGLE_TEXT_MODEL: ${{ vars.GOOGLE_TEXT_MODEL || 'gemini-2.0-flash' }}
      GOOGLE_MM_MODEL: ${{ vars.GOOGLE_MM_MODEL || 'gemini-2.0-flash' }}
      GOOGLE_ASR_MODEL: ${{ vars.GOOGLE_ASR_MODEL || 'gemini-2.0-flash' }}

      GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
      GROQ_BASE_URL: ${{ vars.GROQ_BASE_URL || 'https://api.groq.com/openai/v1' }}
      GROQ_TEXT_MODEL: ${{ vars.GROQ_TEXT_MODEL || 'llama-3.3-70b-versatile' }}
      GROQ_MM_MODEL: ${{ vars.GROQ_MM_MODEL || 'llama-3.2-90b-vision-preview' }}
      GROQ_ASR_MODEL: ${{ vars.GROQ_ASR_MODEL || 'whisper-large-v3' }}

      MISTRAL_API_KEY: ${{ secrets.MISTRAL_API_KEY }}
      MISTRAL_BASE_URL: ${{ vars.MISTRAL_BASE_URL || 'https://api.mistral.ai/v1' }}
      MISTRAL_TEXT_MODEL: ${{ vars.MISTRAL_TEXT_MODEL || 'mistral-large-latest' }}
      MISTRAL_MM_MODEL: ${{ vars.MISTRAL_MM_MODEL || 'pixtral-large-latest' }}
      MISTRAL_ASR_MODEL: ${{ vars.MISTRAL_ASR_MODEL || 'voxtral-mini-latest' }}

      MAX_BASE64_CHARS: ${{ vars.MAX_BASE64_CHARS || '2000000' }}
      MAX_UPLOAD_MB: ${{ vars.MAX_UPLOAD_MB || '25' }}
      ALLOWED_IMAGE_MIME: ${{ vars.ALLOWED_IMAGE_MIME || 'image/png,image/jpeg,image/heic' }}
      ALLOWED_AUDIO_MIME: ${{ vars.ALLOWED_AUDIO_MIME || 'audio/m4a,audio/mp4,audio/mpeg,audio/wav,audio/x-wav' }}

      INSIGHTS_CRON: ${{ vars.INSIGHTS_CRON || '0 1 * * *' }}
      SUMMARY_CRON: ${{ vars.SUMMARY_CRON || '0 2 * * 0' }}
      SUMMARY_WINDOW_DAYS: ${{ vars.SUMMARY_WINDOW_DAYS || '7' }}
      CUSTOM_OPERATION_MODE: ${{ vars.CUSTOM_OPERATION_MODE || 'ON_EACH_TRIGGER' }}
      CUSTOM_OPERATION_CRON: ${{ vars.CUSTOM_OPERATION_CRON || '0 */6 * * *' }}

      SYNC_ENABLE: ${{ vars.SYNC_ENABLE || 'false' }}
      SYNC_DEFAULT_FREQUENCY: ${{ vars.SYNC_DEFAULT_FREQUENCY || 'ON_EVENT' }}
      SYNC_DEFAULT_CRON: ${{ vars.SYNC_DEFAULT_CRON || '0 9 * * *' }}
      SYNC_SEND_TIMELINE: ${{ vars.SYNC_SEND_TIMELINE || 'true' }}
      SYNC_SEND_INSIGHT: ${{ vars.SYNC_SEND_INSIGHT || 'false' }}
      SYNC_SEND_SUMMARY: ${{ vars.SYNC_SEND_SUMMARY || 'true' }}
      SYNC_SEND_CUSTOMIZED: ${{ vars.SYNC_SEND_CUSTOMIZED || 'false' }}
      SYNC_SEND_ERRORS: ${{ vars.SYNC_SEND_ERRORS || 'true' }}

      FEISHU_ENABLED: ${{ vars.FEISHU_ENABLED || 'false' }}
      FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
      TELEGRAM_ENABLED: ${{ vars.TELEGRAM_ENABLED || 'false' }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      DISCORD_ENABLED: ${{ vars.DISCORD_ENABLED || 'false' }}
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      WHATSAPP_ENABLED: ${{ vars.WHATSAPP_ENABLED || 'false' }}
      WHATSAPP_GATEWAY_URL: ${{ secrets.WHATSAPP_GATEWAY_URL }}
      WHATSAPP_TOKEN: ${{ secrets.WHATSAPP_TOKEN }}

      REQUEST_SIGNATURE_SECRET: ${{ secrets.REQUEST_SIGNATURE_SECRET }}
      SKIP_SIGNATURE_VERIFICATION: ${{ vars.SKIP_SIGNATURE_VERIFICATION || 'true' }}
      GITHUB_RELEASE_INBOX_TAG: ${{ vars.AURACAP_RELEASE_INBOX_TAG || 'auracap-inbox' }}
      GITHUB_RELEASE_DELETE_AFTER_PROCESS: ${{ vars.AURACAP_RELEASE_DELETE_AFTER_PROCESS || 'true' }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Process dispatch
        run: PYTHONPATH=. python scripts/process_github_dispatch.py "$GITHUB_EVENT_PATH"
      - name: Persist storage artifacts
        if: ${{ success() }}
        run: |
          if [[ -n "$(git status --porcelain storage/)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add storage/
            git commit -m "chore(storage): update artifacts from ingest run $GITHUB_RUN_ID"
            git pull --rebase origin "$GITHUB_REF_NAME"
            git push origin "HEAD:$GITHUB_REF_NAME"
          else
            echo "No storage changes to commit"
          fi
